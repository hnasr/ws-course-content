worker_processes auto;

events { }

http {
    # Handy for Connection header on upgrade
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    upstream h1_backend {
        server 127.0.0.1:7443;
        server 127.0.0.1:6443;
        server 127.0.0.1:5443;
        server 127.0.0.1:4443;
    }

    server {
        listen 8443 ssl;
        server_name localhost;

        ssl_certificate     /Users/HusseinNasser/projects/ws-course-content/keys/server.crt;
        ssl_certificate_key /Users/HusseinNasser/projects/ws-course-content/keys/server.key;
        ssl_protocols       TLSv1.2 TLSv1.3;

        location / {
            proxy_pass              https://h1_backend;

            # REQUIRED for WebSocket over HTTP/1.1
            proxy_http_version      1.1;
            proxy_set_header        Upgrade $http_upgrade;
            proxy_set_header        Connection $connection_upgrade;

            # Real-time friendly
            proxy_buffering         off;
            proxy_read_timeout      3600s;
            proxy_send_timeout      3600s;

            # If your upstreams use TLS with a cert for "localhost", send SNI = localhost
            proxy_ssl_server_name   on;
            proxy_ssl_name          localhost;

            # For dev/self-signed backends
            proxy_ssl_verify        off;
        }
    }
}
